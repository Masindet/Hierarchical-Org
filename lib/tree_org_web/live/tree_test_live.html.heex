<%= if Phoenix.Flash.get(@flash, :info) do %>
  <div class="mb-4 p-2 bg-green-200 text-green-800 rounded text-center">
    <%= Phoenix.Flash.get(@flash, :info) %>
  </div>
<% end %>
<%= if Phoenix.Flash.get(@flash, :error) do %>
  <div class="mb-4 p-2 bg-red-200 text-red-800 rounded text-center">
    <%= Phoenix.Flash.get(@flash, :error) %>
  </div>
<% end %>
<div class="min-h-screen flex flex-row justify-center w-full bg-white">
   <!--add user form & button -->
    <div class="bg-gray-100 w-1/3 px-4 py-2 rounded"> 
        <div class="text-center mb-4">
            <button phx-click="toggle_form" class="bg-blue-400 hover:bg-blue-700 text-white px-4 py-2 rounded">
                Add User
            </button>
        </div>
        
        <!--form is only visible if @show_form is true -->
        <%= if @show_form do %>
            <div class="bg-gray-200 p-6 rounded shadow">
                <h2 class="text-xl font-semibold mb-4">
                    Add New User
                </h2>
                <%= if @form_error do %>
                    <div class="mb-4 p-2 bg-red-200 text-red-800 rounded">
                        <%= @form_error %>
                    </div>
                <% end %>
                <.form for={%{}} phx-submit="add_user" phx-change="update_form">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-md font-semibold mb-2">
                            Name
                        </label>
                        <input type="text" name="user[name]" value={@form_data["name"]} class="shadow borlder rounded w-full py-2 px-3 text-gray-700" />

                        <!--1. dropdown for roles not sure if it should be -->
                        <div class="mb-4">
                            <label class="block text-gray-700 text-md font-semibold mb-2">
                                Role
                            </label>
                            <input type="text" name="user[role]" class="shadow border rounded w-full py-2 px-3 text-gray-900" value={@form_data["role"]} placeholder="Enter Role" />
                        </div>

                        <!--2. dropdown for reports to -->
                        <div class="mb-4">
                            <label class="block text-gray-700 text-md font-semibold mb-2">
                                Reports To
                            </label>
                            <%= if @dropdown_options == [] do %>
                                <div class="p-2 bg-gray-100 text-gray-500 rounded">No existing users - this will be the first user</div>
                            <% else %>
                                <select name="user[reports_to]" class="shadow border rounded w-full py-2 px-3 text-gray-900" required>
                                    <option value="" disabled selected={@form_data["reports_to"] in [nil, "", "--Select--"]}>--Select--</option>
                                    <%= for option <- @dropdown_options do %>
                                        <option value={option.value} selected={@form_data["reports_to"] == option.value}>
                                            <%= option.display %>
                                        </option>
                                    <% end %>
                                </select>
                            <% end %>
                        </div>

                        <div class="flex space-x-2">
                            <button type="submit" class="bg-blue-400 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded">
                                Add User
                            </button>
                            <button type="button" phx-click="toggle_form" class="bg-gray-500 hover:bg-gray-900 text-white font-semibold py-2 px-4 rounded">
                                Cancel
                            </button>
                        </div>
                    </div> 
    
                </.form>
            </div>
        <% end %>
        
        <!-- Edit form is only visible if @show_edit_form is true -->
        <%= if @show_edit_form do %>
            <div class="bg-gray-200 p-6 rounded shadow mt-4">
                <h2 class="text-xl font-semibold mb-4">
                    Edit User
                </h2>
                <%= if @form_error do %>
                    <div class="mb-4 p-2 bg-red-200 text-red-800 rounded">
                        <%= @form_error %>
                    </div>
                <% end %>
                <.form for={%{}} phx-submit="update_node" phx-change="update_edit_form">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-md font-semibold mb-2">
                            Name
                        </label>
                        <input type="text" name="edit_user[name]" value={@edit_form_data["name"]} class="shadow border rounded w-full py-2 px-3 text-gray-700" />

                        <div class="mb-4">
                            <label class="block text-gray-700 text-md font-semibold mb-2">
                                Role
                            </label>
                            <input type="text" name="edit_user[role]" class="shadow border rounded w-full py-2 px-3 text-gray-900" value={@edit_form_data["role"]} placeholder="Enter Role" />
                        </div>

                        <input type="hidden" name="edit_user[node_id]" value={@edit_form_data["node_id"]} />

                        <div class="flex space-x-2">
                            <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded">
                                Update User
                            </button>
                            <button type="button" phx-click="cancel_edit" class="bg-gray-500 hover:bg-gray-900 text-white font-semibold py-2 px-4 rounded">
                                Cancel
                            </button>
                        </div>
                    </div> 
    
                </.form>
            </div>
        <% end %>
    </div>

    <div class="flex-1 px-6 py-2">
        <h1 class="text-2xl font-bold mb-6 text-center">Organizational Chart</h1>
        
        
        <!-- Tree display - completely re-render on version change -->
        <div class="flex justify-center">
            <%= if @tree_version do %>
                <div id={"tree-v#{@tree_version}"}>
                    <%= if @tree do %>
                        <.render_tree node={@tree} />
                    <% else %>
                        <div class="text-center p-8">
                            <div class="text-gray-500 text-lg mb-4">
                                No organizational chart yet
                            </div>
                            <div class="text-gray-400 text-sm">
                                Add your first user to get started!
                            </div>
                        </div>
                    <% end %>
                </div>
            <% end %>
        </div>
    </div>      
    
</div>